version: '3.8'

services:
  # PowerDNS server with bind backend (new implementation)
  pdns-server:
    image: powerdns/pdns-auth-49:4.9.5
    container_name: pdns-test-server
    hostname: pdns-server
    user: root
    networks:
      dns-test-network:
        ipv4_address: 172.25.0.10
    ports:
      - "5300:53/udp"
      - "5300:53/tcp"
    volumes:
      # Mount configuration files
      - ./pdns/pdns.conf:/etc/powerdns/pdns.conf:ro
      - ./pdns/named.conf:/etc/powerdns/named.conf:ro
      # Mount zone files (Docker test versions)
      - ./zones/app.runonflux.io.zone:/etc/powerdns/zones/app.runonflux.io.zone:ro
      - ./zones/app2.runonflux.io.zone:/etc/powerdns/zones/app2.runonflux.io.zone:ro
      - ./zones/cdn-geo.runonflux.io.zone:/etc/powerdns/zones/cdn-geo.runonflux.io.zone:ro
      # Mount Lua scripts (Docker version with mock servers)
      - ./scripts/:/opt/pdns/scripts/:ro
      # Mount GeoIP databases (mock)
      - ./geoip/:/usr/share/GeoIP/:ro
    environment:
      - PDNS_AUTH_API_KEY=test-api-key
    entrypoint: []
    command: 
      - sh
      - -c
      - |
        # Ensure directories exist
        mkdir -p /var/run/pdns /var/log/pdns &&
        # Start PowerDNS
        pdns_server --daemon=no --guardian=no --write-pid=no --loglevel=6

  # Mock CDN servers for testing geo-routing and health checks
  cdn-6-mock:
    image: nginx:alpine
    container_name: cdn-6-mock
    hostname: cdn-6-mock
    networks:
      dns-test-network:
        ipv4_address: 172.25.0.50
    ports:
      - "8081:80"
    volumes:
      - ./cdn-mock/cdn-6:/usr/share/nginx/html:ro
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 5s
      timeout: 3s
      retries: 3

  cdn-1-mock:
    image: nginx:alpine
    container_name: cdn-1-mock
    hostname: cdn-1-mock
    networks:
      dns-test-network:
        ipv4_address: 172.25.0.51
    ports:
      - "8082:80"
    volumes:
      - ./cdn-mock/cdn-1:/usr/share/nginx/html:ro
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 5s
      timeout: 3s
      retries: 3

  cdn-4-mock:
    image: nginx:alpine
    container_name: cdn-4-mock
    hostname: cdn-4-mock
    networks:
      dns-test-network:
        ipv4_address: 172.25.0.52
    ports:
      - "8083:80"
    volumes:
      - ./cdn-mock/cdn-4:/usr/share/nginx/html:ro
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 5s
      timeout: 3s
      retries: 3

  # DNS client for running tests
  dns-client:
    image: alpine:latest
    container_name: dns-test-client
    hostname: dns-client
    networks:
      dns-test-network:
        ipv4_address: 172.25.0.20
    volumes:
      # Mount test client tools
      - ./client/:/client/:ro
    command:
      - sh
      - -c
      - |
        # Install required packages
        apk add --no-cache bind-tools bash curl jq &&
        # Keep container running for tests
        tail -f /dev/null
    depends_on:
      - pdns-server

  # Test runner and validation service
  test-runner:
    image: alpine:latest
    container_name: dns-test-runner
    hostname: test-runner
    networks:
      dns-test-network:
        ipv4_address: 172.25.0.30
    volumes:
      - ./tests/:/tests/:ro
      - ./results/:/results/:rw
    command:
      - sh
      - -c
      - |
        # Install required packages
        apk add --no-cache bind-tools bash curl jq python3 &&
        # Wait for DNS server to be ready
        sleep 15 &&
        # Run production validation tests
        /tests/validate_production.sh
    depends_on:
      - pdns-server

networks:
  dns-test-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
          gateway: 172.25.0.1

volumes:
  test-results:
    driver: local