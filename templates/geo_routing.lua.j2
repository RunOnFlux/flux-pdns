-- PowerDNS Lua script for geographic routing with health checks
-- This script handles DNS queries for geo-routing zones
-- Generated from template - DO NOT EDIT MANUALLY

-- Server configuration with IP addresses and geographic locations
{% set env = 'staging' if DEPLOY_ENV == 'staging' else 'production' %}
{% set all_regions = [] %}
{% for zone_config in powerdns[env].zone_configs %}
  {% if zone_config.template_vars.geo_routing | default(false) %}
    {% for region in zone_config.template_vars.geo_regions | default([]) %}
      {% set _ = all_regions.append(region) %}
    {% endfor %}
  {% endif %}
{% endfor %}
servers = {
{% for region in all_regions %}
    {
        name = "{{ region.server }}",
        ip = "{{ region.ip }}",
        location = "{{ region.name }}"
    }{{ "," if not loop.last else "" }}
{% endfor %}
}


-- Function to get all server IPs
function getAllServerIPs()
    local ips = {}
    for _, server in ipairs(servers) do
        table.insert(ips, server.ip)
    end
    return ips
end


-- Main geo-routing function called by PowerDNS
function geoRoute()
    local all_ips = getAllServerIPs()

    -- Health check with working parameters
    local available_ips = ifportup(443, all_ips, {
        timeout = 2,                 -- 2 seconds connection timeout
        minimumFailures = 3,         -- 3 consecutive failures before marking as down
        interval = 15,               -- Check every 15 seconds
        selector = 'pickclosest',    -- Use geographic selection for healthy servers
        backupSelector = 'pickclosest' -- Use geographic selection even when all appear down
    })

    return available_ips
end


-- Alternative function for weighted geographic routing
function geoRouteWeighted()
    local all_ips = getAllServerIPs()

    -- Health check with same parameters as above
    local available_ips = ifportup(443, all_ips, {
        timeout = 2,
        minimumFailures = 3,
        interval = 15,
        selector = 'all'       -- Return ALL healthy servers, not just one
    })

    -- Return weighted selection based on geographic distribution
    return pickwrandom(available_ips)
end

-- Function for A record queries specifically
function geoRouteA()
    return geoRoute()
end

-- Function for AAAA record queries (IPv6) - returns empty for now
function geoRouteAAAA()
    return {}
end

-- Function to get server status (for monitoring/debugging)
function getServerStatus()
    local all_ips = getAllServerIPs()
    local available_ips = ifportup(443, all_ips, {
        timeout = 2,
        minimumFailures = 3,
        interval = 15,
        selector = 'all'
    })

    local status_parts = {}
    local up_count = 0
    local down_count = 0

    -- Create lookup table for available IPs
    local available_lookup = {}
    for _, ip in ipairs(available_ips) do
        available_lookup[ip] = true
    end

    for _, server in ipairs(servers) do
        local is_up = available_lookup[server.ip] ~= nil
        local status_info = server.location .. ":" .. (is_up and "UP" or "DOWN")
        table.insert(status_parts, status_info)

        if is_up then
            up_count = up_count + 1
        else
            down_count = down_count + 1
        end
    end

    -- Format as a single string suitable for TXT record
    local summary = string.format("UP:%d DOWN:%d", up_count, down_count)
    return summary .. " " .. table.concat(status_parts, ",")
end
