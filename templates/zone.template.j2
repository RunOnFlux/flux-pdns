; Generic DNS Zone Template - {{ zone_name }}
; Environment: {{ environment }}
; Generated: {{ ansible_date_time.iso8601 | default('Manual') }}
;
$TTL {{ default_ttl | default('3600') }}
$ORIGIN {{ zone_name }}.

; SOA record
@       IN      SOA     {{ soa_nameserver }} hostmaster.{{ zone_name }}. (
                        {{ serial }}      ; Serial (YYYYMMDD00, auto-managed by PowerDNS)
                        3600            ; Refresh
                        600             ; Retry
                        86400           ; Expire
                        {{ default_ttl | default('3600') }} )          ; Minimum TTL

; Name servers for this zone
{% for ns in nameservers %}
@       IN      NS      {{ ns }}
{% endfor %}

{% if lua_routing | default(false) %}
; Load Lua functions for dynamic routing
_config         IN      LUA     LUA     "dofile('/opt/pdns/scripts/{{ routing_script | default('app_routing.lua') }}')"

; Wildcard routing using Lua records
{% if routing_function is defined %}
*               IN      LUA     CNAME   ";include('_config'); return {{ routing_function }}(qname)"
{% endif %}

{% if debug_function is defined %}
; Debug endpoint to see routing decisions
_debug          IN      LUA     TXT     ";include('_config'); return {{ debug_function }}(qname)"
{% endif %}
{% endif %}

{% if geo_routing | default(false) %}
; Geographic routing configuration
_config         IN      LUA     LUA     "dofile('/opt/pdns/scripts/geo_routing.lua')"

; Main geographic routing record
@               IN      LUA     A       ";include('_config'); return geoRoute(qname)"

; Health check records for monitoring
{% for region in geo_regions | default([]) %}
_health.{{ region.name }}    300    IN    TXT    "{{ region.description }} - {{ region.server }} - {{ region.ip }}"
{% endfor %}
{% endif %}

{% if custom_records is defined %}
; Custom records
{% for record in custom_records %}
{{ record.name }}{% if record.ttl is defined %}    {{ record.ttl }}{% endif %}    IN    {{ record.type }}    {{ record.value }}
{% endfor %}
{% endif %}

; Standard records (if not using dynamic routing)
{% if not lua_routing and not geo_routing %}
{% if a_records is defined %}
; A records
{% for record in a_records %}
{{ record.name | default('@') }}    {{ record.ttl | default('') }}    IN    A    {{ record.ip }}
{% endfor %}
{% endif %}

{% if cname_records is defined %}
; CNAME records
{% for record in cname_records %}
{{ record.name }}    {{ record.ttl | default('') }}    IN    CNAME    {{ record.target }}
{% endfor %}
{% endif %}
{% endif %}