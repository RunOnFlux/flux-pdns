# PowerDNS Configuration with Geo-routing and Lua Records
# This configuration enables both the pipe backend and Lua records for geo-routing

# Primary backend - Bind backend for all zones, plus GeoIP for Lua Records
launch=bind,geoip

# Bind backend configuration for all zones
bind-config=/etc/powerdns/named.conf
bind-check-interval=60

# Enable Lua records for geo-routing
enable-lua-records=yes
lua-health-checks-interval=2

# GeoIP configuration for Lua Records (MMDB format)
geoip-database-files=mmdb:/usr/share/GeoIP/GeoLite2-City.mmdb;mode=mmap;language=en

# EDNS Client Subnet for better geo-location accuracy
edns-subnet-processing=yes

# Performance and caching settings
cache-ttl=60
negquery-cache-ttl=60
query-cache-ttl=20
max-cache-entries=1000000

# Logging configuration
loglevel=5
log-dns-queries=yes
log-dns-details=yes

# Security settings
webserver=no
api=no

# DNSSEC settings - prevent DNSSEC key responses to avoid REFUSED responses
direct-dnskey=no

# Network settings
local-address=0.0.0.0
local-port=53
socket-dir=/var/run/pdns

# Thread settings
distributor-threads=3
receiver-threads=2

# Query settings
max-tcp-connections=20
max-queue-length=5000

# Master/Slave replication settings
{% set server_role = pdns_role | default('slave') %}

{% if server_role == 'master' %}
# Master server configuration
primary=yes
secondary=no

# Collect slave IPs from inventory
{% set slave_ips = [] %}
{% for host in groups[group_names[0]] %}
  {% if hostvars[host].pdns_role == 'slave' %}
    {% set _ = slave_ips.append(hostvars[host].ansible_host) %}
  {% endif %}
{% endfor %}

# Configure TSIG for zone transfers
# When TSIG is configured, allow-axfr-ips is ignored for TSIG-authenticated requests
# We keep localhost for debugging without TSIG
allow-axfr-ips=127.0.0.1

# Allow AXFR with TSIG key "zone-transfer" for all zones
tsig-allow-axfr=zone-transfer

# Notify slaves when zones change
also-notify={{ slave_ips | join(',') }}

# Enable DNS updates for ACME challenges
dnsupdate=yes
allow-dnsupdate-from=127.0.0.1

{% else %}
# Slave server configuration
primary=no
secondary=yes
slave-renotify=yes

# Only localhost can query AXFR (TSIG required for remote)
allow-axfr-ips=127.0.0.1
{% endif %}

# TSIG keys for secure zone transfers
include-dir=/etc/powerdns/tsig-keys
